<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halo Embedded Report</title>
    <style>
        html, body, #reportContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            border: 0;
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #666;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div id="reportContainer">
        <p>Loading Report...</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/powerbi-client@2.22.1/dist/powerbi.min.js"></script>

    <script>
        const backendApiUrl = '/api/GetEmbedToken';
        const reportContainer = document.getElementById('reportContainer');

        async function embedReport() {
            try {
                // Get embed details from your backend.
                const response = await fetch(backendApiUrl);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Backend service error. Status: ${response.status}. Message: ${errorText}`);
                }
                const embedDetails = await response.json();

                // Create the configuration object for embedding.
                const embedConfig = {
                    type: 'report',
                    id: embedDetails.reportId,
                    embedUrl: embedDetails.embedUrl,
                    accessToken: embedDetails.embedToken,
                    tokenType: powerbi.models.TokenType.Embed,
                    settings: {
                        panes: {
                            filters: { expanded: false, visible: true },
                            pageNavigation: { visible: true }
                        }
                    }
                };

                // Embed the report.
                powerbi.embed(reportContainer, embedConfig);

            } catch (error) {
                console.error(error);
                reportContainer.innerHTML = `<p><strong>Error:</strong> Could not embed report. ${error.message}</p>`;
            }
        }
        
        // Use the 'load' event to ensure all scripts are ready before running.
        window.addEventListener('load', embedReport);
    </script>
</body>
</html>