<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halo Embedded Report</title>
    <style>
        /* This CSS makes the report fill the entire page/iframe */
        html, body, #reportContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            border: 0;
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #666;
            box-sizing: border-box; /* Ensures padding and border are included in the total width/height */
        }
    </style>
</head>
<body>
    <div id="reportContainer">
        <p>Loading Report...</p>
    </div>

    <script src="https://microsoft.github.io/PowerBI-JavaScript/demo/dist/powerbi.min.js"></script>

    <script>
        // --- CONFIGURATION ---
        // This is the relative URL to your Azure Function within the Static Web App.
        const backendApiUrl = '/api/GetEmbedToken';

        // The container element in your HTML where the report will be loaded.
        const reportContainer = document.getElementById('reportContainer');

        // --- MAIN FUNCTION ---
        // This async function orchestrates the entire process.
        async function embedReport() {
            try {
                // Step 1: Get the embed token and details from your backend service.
                const response = await fetch(backendApiUrl);

                // If the backend returned an error, show a helpful message.
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Backend service error. Status: ${response.status}. Message: ${errorText}`);
                }

                const embedDetails = await response.json();

                // Step 2: Create the configuration object for the Power BI client library.
                // This object tells the library everything it needs to know to render the report.
                const embedConfig = {
                    type: 'report',
                    id: embedDetails.reportId,       // The ID of the report to embed
                    embedUrl: embedDetails.embedUrl, // The embed URL for the report
                    accessToken: embedDetails.embedToken, // The crucial, short-lived embed token
                    tokenType: models.TokenType.Embed,
                    settings: {
                        panes: {
                            filters: {
                                expanded: false,
                                visible: true // You can hide or show the filters pane
                            },
                            pageNavigation: {
                                visible: true // Show or hide the page navigation at the bottom
                            }
                        }
                    }
                };

                // Step 3: Embed the report into the container, replacing the "Loading..." message.
                powerbi.embed(reportContainer, embedConfig);

            } catch (error) {
                // If anything goes wrong, display a clear error message in the container.
                console.error(error);
                reportContainer.innerHTML = `<p><strong>Error:</strong> Could not embed report.</p><p style="font-size: 0.8em;">${error.message}</p>`;
            }
        }
        
        // --- START THE PROCESS ---
        // Run the main function as soon as the page's main content has loaded.
        document.addEventListener('DOMContentLoaded', embedReport);
    </script>
</body>
</html>